"use strict";const{shell:shell}=require("electron").remote,{ipcRenderer:ipcRenderer}=require("electron"),Store=require("electron-store"),store=new Store,{remote:remote}=require("electron"),dialog=remote.dialog,$=require("jquery"),dt=require("datatables.net")(window,$),keytable=require("datatables.net-keytable")(window,$);let modal,generate=require("string-to-color");const bookmarkTable=$("#bookmarks").DataTable({keys:{tabIndex:1,blurable:!0,keys:[32,38,40]},scrollY:"calc(100vh - 122px)",paging:!1,columnDefs:[{className:"dt-body-right",targets:[4,5]},{className:"padded-left",targets:[1]},{className:"dt-body-right padded-right",targets:[6]},{targets:[0],visible:!1,searchable:!1},{targets:[2],visible:store.get("tableColumns.description")},{targets:[3],visible:store.get("tableColumns.url")},{targets:[4],visible:store.get("tableColumns.created"),searchable:!1},{targets:[5],visible:store.get("tableColumns.modified"),searchable:!1}],language:{search:"",searchPlaceholder:"search"}});var total;const server=store.get("loginCredentials.server"),username=store.get("loginCredentials.username"),password=store.get("loginCredentials.password");function getBookmarks(){let e={method:"GET",headers:{Authorization:"Basic "+btoa(username+":"+password),"Content-Type":"application/json"},mode:"cors",cache:"default"};fetch(server+"/index.php/apps/bookmarks/public/rest/v2/bookmark?page=-1",e).then(function(e){if(e.ok)return console.log("response OK"),e.text();dialog.showErrorBox("Server connection error",`there was an error connecting to: ${server}`),console.log(e.error())}).then(function(e){let t=JSON.parse(e);"error"==t.status?(dialog.showErrorBox("JSON parsing error","An error occured parsing the bookmarks"),console.log(t.message)):(total=t.data.length,parseBookmarks(t.data))}).catch(function(e){dialog.showErrorBox("Server connection error",`there was an error connecting to: ${server}`),console.log(e)})}function parseBookmarks(e){let t=[];for(let o of e){let e="";o.tags.length<1&&o.tags.push("un-tagged");for(let r of o.tags){let o;e+=`<span class="tag" title="${r}" style="background-color: ${o="un-tagged"===r?"transparent":generate(r)};">${r}</span>`,t.push(r)}let r=new Date(1e3*o.added),a=new Date(1e3*o.lastmodified);bookmarkTable.row.add([o.id,htmlEntities(o.title),htmlEntities(o.description),o.url,r.toLocaleDateString(),a.toLocaleDateString(),e]).draw(!1)}buildTagList(t.sort())}function buildTagList(e){$(".taglist").html("");let t=[],o=e.slice(0);for(var r=0;r<e.length;r++){for(var a=0,l=0;l<o.length;l++)e[r]==o[l]&&(a++,delete o[l]);if(a>0){var s=new Object;s.value=e[r],s.count=a,t.push(s)}}let n=[],i="",d=1;for(let e of t)if("un-tagged"===e.value)i=`<dd class="margin-top">\n\t\t\t\t<a href="#" class="filter" data-filter="${e.value}">${e.value}\n\t\t\t\t<span class="tag-count">${e.count}</span></a>\n\t\t\t</dd>`;else{var c=generate(e.value);$("#taglist").append(`<dd>\n\t\t\t\t<a href="#" class="filter" data-filter="${e.value}"><span class="tag" title="${e.value}" style="background-color: ${c};">${e.value}</span> ${e.value}\n\t\t\t\t<span class="tag-count">${e.count}</span></a>\n\t\t\t</dd>`),n.push({id:d,text:e.value}),d++}store.set("tags",n),$("#taglist-extras").append(`${i}\n\t\t<dd>\n\t\t\t<a href="#" class="filter selected" data-filter="">all bookmarks <span class="tag-count">${total}</span></a>\n\t\t</dd>`)}function openModal(e,t,o,r){(modal=new remote.BrowserWindow({parent:remote.getCurrentWindow(),modal:!0,width:t,minWidth:t,maxWidth:t,height:o,minHeight:o,resizable:r,show:!1,backgroundColor:"#ECECEC"})).loadURL(e),modal.once("ready-to-show",()=>{modal.show()})}function setColControls(){let e=store.get("tableColumns");for(let t in e)$(`#${t}`).prop("checked",e[t])}function htmlEntities(e){return String(e).replace(/</g,"&lt;").replace(/>/g,"&gt;")}ipcRenderer.on("delete-bookmark",(e,t)=>{let o=!1;if(o="delete-bookmark"==t?bookmarkTable.row(".selected").data():t){if(0===dialog.showMessageBox({message:`Are you sure you want to delete the bookmark ${o[1]}?`,detail:"This operation is not reversable.",buttons:["Delete Bookmark","Cancel"]})){const e="/index.php/apps/bookmarks/public/rest/v2/bookmark/";let t={method:"DELETE",headers:{Authorization:"Basic "+btoa(username+":"+password),"Content-Type":"application/json"},mode:"cors",cache:"default"};fetch(server+e+o[0],t).then(function(e){return e.ok?e.text():(dialog.showErrorBox("Delete Bookmark Error",`An error occured whilst trying to delete the bookmark: ${o[1]}`),e.text())}).then(function(e){bookmarkTable.clear().draw(),getBookmarks()})}}else dialog.showErrorBox("Delete Bookmark Error","An entry must be selected in order to delete")}),ipcRenderer.on("edit-bookmark",(e,t)=>{let o=!1;(o="edit-bookmark"==t?bookmarkTable.row(".selected").data():t)?openModal("file://"+__dirname+"/../html/edit-bookmark.html?id="+o[0],480,340,!0):dialog.showErrorBox("Edit Bookmark Error","An entry must be selected in order to edit")}),ipcRenderer.on("edit-tag",(e,t)=>{openModal("file://"+__dirname+"/../html/edit-tag.html?tag="+t,480,180,!0)}),ipcRenderer.on("delete-tag",(e,t)=>{if(0===dialog.showMessageBox({message:`Are you sure you want to delete the tag ${t}?`,detail:"This operation is not reversable.",buttons:["Delete Tag","Cancel"]})){const e="/index.php/apps/bookmarks/public/rest/v2/";let o={method:"DELETE",headers:{Authorization:"Basic "+btoa(username+":"+password),"Content-Type":"application/json"},mode:"cors",cache:"default"};console.log(server+e+"tag?old_name="+encodeURIComponent(t)),fetch(server+e+"tag?old_name="+encodeURIComponent(t),o).then(function(e){return e.ok?e.text():(console.log(e.text()),dialog.showErrorBox("Delete Tag Error",`An error occured whilst trying to delete the tag: ${t}`),e.text())}).then(function(e){bookmarkTable.clear().draw(),getBookmarks()})}}),ipcRenderer.on("open-preferences",(e,t)=>{openModal("file://"+__dirname+"/../html/login.html",480,180,!1)}),ipcRenderer.on("refresh-bookmarks",(e,t)=>{bookmarkTable.clear().draw(),getBookmarks()}),ipcRenderer.on("add-bookmark",(e,t)=>{openModal("file://"+__dirname+"/../html/add-bookmark.html",480,340,!0)}),ipcRenderer.on("close-login-modal",(e,t)=>{modal.close()}),$(document).ready(function(){getBookmarks(),setColControls(),$(".taglist").on("click",".filter",function(){$(".filter").removeClass("selected"),$(this).addClass("selected");let e=$(this).data("filter");bookmarkTable.columns(6).search(e).draw()}),$("#taglist").on("mousedown",".filter",function(e){if(3==e.which){let e=$(this).data("filter");ipcRenderer.send("show-tags-menu",e)}}),$(".col-toggle").on("click",function(){let e=bookmarkTable.column($(this).attr("data-column")),t=$(this).prop("id");!0===$(this).prop("checked")?(e.visible(!0),store.set(`tableColumns.${t}`,!0)):(e.visible(!1),store.set(`tableColumns.${t}`,!1))}),$("#add-bookmark").click(function(){openModal("file://"+__dirname+"/../html/add-bookmark.html",480,340,!0)}),$("body #bookmarks tbody").on("mouseup","tr",function(e){if(3===e.which){let e=bookmarkTable.row(this).data();e&&ipcRenderer.send("show-bookmark-menu",e)}}),$("#bookmarks").on("key-focus.dt",function(e,t,o){$(bookmarkTable.row(o.index().row).node()).addClass("selected")}),$("#bookmarks").on("key-blur.dt",function(e,t,o){$(bookmarkTable.row(o.index().row).node()).removeClass("selected")}),$("#bookmarks").on("key.dt",function(e,t,o,r,a){if(32===o&&!$("#add-bookmark, .col-toggle").is(":focus")){const e=bookmarkTable.row(r.index().row).data();shell.openExternal(e[3])}}),server&&username&&password||openModal("file://"+__dirname+"/../html/login.html",480,180,!1)});
//# sourceMappingURL=maps/app.min.js.map
